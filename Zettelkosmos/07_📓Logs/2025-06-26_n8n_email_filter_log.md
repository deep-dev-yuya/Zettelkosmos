---
title: "n8n Gmail通知Botの除外フィルタ開発"
created: 2025-06-26
tags: ["n8n", "Gmail", "LINE", "自動化", "通知", "振り返り"]
type: "log"
---


## ✅ タスク（今日やること）
- [x] n8nで「GmailのIMAP受信 → LINE通知」のフィルタ処理を完成
- [x] 除外対象（件名・送信者・本文）の精密化とエッジケース検証
- [x] 通知されてはいけないパターン（QUOカード／プロフィール画像）を明示的に除外
- [x] 成功パターンと失敗パターンの差分確認と調整
- [x] LINE通知内容の見直しと整形ロジックの確認

---

## 💻 AIからの振り返り

### ✅ 良かったこと
- 除外リスト（NGワード／NG送信者）を整理・拡充し、明確な定義に基づく運用が可能になった
- `textPlain` や `textHtml` など、マルチパートメール構造を考慮したフィルタ設計が進展
- `コード1` ノードの役割を明確化し、「通す or 除外」のロジックを一元管理できた
- LINE通知結果との照合により、実データベースで動作確認ができた

### ❗ 苦戦したこと
- `件名: プレゼント 本文: セール` のように明らかに除外すべきパターンでも通知されていた
- `n8n`のFunctionノードにて、入力構造や定義ミスに起因する除外処理のバグが多発
- 差出人（From）項目の抽出において、`[object Object]` と表示されることがあり、整形処理が必要だった
- プロフィール画像など、UI系HTMLメールでの文字化けをどう扱うかが課題となった

### 🔧 対策と改善
- NGリストを「単語」ベースでなく「部分一致文字列（小文字化含む）」で判定することで精度向上
- 差出人表示は `"from.address"` を優先し、なければ `"from"` をfallbackにする処理を採用
- NGワード中に `Â©` や `ãƒ` のような文字化けパターンを追加し、UI型メールを除外
- **誤通知時の再現性ログ** をコンソール出力に記録（subject/sender/body/判定フラグ）
